<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¹²çªçœ¼å„¿">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJNMTIgMkwyIDEySDEyVjJaIi8+CjxwYXRoIGQ9Ik0xMiAyTDIyIDEySDEyVjJaIi8+CjxwYXRoIGQ9Ik0yMiAxMkwyIDEyIi8+CjxwYXRoIGQ9Ik0xMiAxMkwyMiAyMiIvPgo8cGF0aCBkPSJNMTIgMTJMMiAyMiIvPgo8L3N2Zz4KPC9zdmc+">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å¹²çªçœ¼å„¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .content {
            padding: 15px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .connected .status-dot {
            background: #28a745;
        }
        
        .disconnected .status-dot {
            background: #dc3545;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        input, button {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            touch-action: manipulation;
        }
        
        button:hover, button:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .room-info {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
        }
        
        .players-list {
            margin-top: 12px;
        }
        
        .player-item {
            padding: 6px 10px;
            background: white;
            margin-bottom: 4px;
            border-radius: 4px;
            border-left: 4px solid #667eea;
            font-size: 0.85em;
        }
        
        .game-area {
            margin-top: 15px;
        }
        
        .player-hand {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .card {
            width: 60px;
            height: 85px;
            background: white;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            touch-action: manipulation;
        }
        
        .card:hover, .card:active {
            transform: translateY(-5px);
        }
        
        .card.selected {
            border-color: #667eea;
            transform: translateY(-10px);
        }
        
        .card.red {
            color: #e74c3c;
        }
        
        .card.black {
            color: #2c3e50;
        }
        
        .card-value {
            font-size: 16px;
            font-weight: bold;
        }
        
        .card-suit {
            font-size: 14px;
            text-align: center;
        }
        
        .game-controls {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        
        .game-controls button {
            flex: 1;
            padding: 10px;
        }
        
        .messages {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            font-size: 0.85em;
        }
        
        .message {
            margin-bottom: 6px;
            padding: 6px 10px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        
        .hidden {
            display: none;
        }
        
        .divider {
            text-align: center;
            margin: 12px 0;
            color: #666;
            font-size: 0.9em;
        }
/* ç‰Œæ¡Œæ ·å¼ */
.game-table {
    background: linear-gradient(135deg, #2d5016 0%, #4a7a1f 100%);
    border-radius: 12px;
    padding: 15px;
    margin: 15px 0;
    border: 3px solid #8b4513;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.table-center {
    display: flex;
    justify-content: space-around;
    align-items: center;
    min-height: 120px;
}

.draw-pile {
    text-align: center;
    color: white;
    cursor: pointer;
}

.pile-label {
    font-size: 0.9em;
    margin-bottom: 5px;
    opacity: 0.8;
}

.pile-count {
    font-size: 1.5em;
    font-weight: bold;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    border: 2px solid gold;
}

.discard-area {
    flex: 1;
    margin-left: 20px;
    color: white;
}

.discard-area h4 {
    margin-bottom: 8px;
    text-align: center;
    color: gold;
}

.discard-history {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    min-height: 60px;
}

.discard-play {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
    padding: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.discard-player {
    font-size: 0.8em;
    color: #333;
    margin-bottom: 5px;
    text-align: center;
    font-weight: bold;
}

.discard-cards {
    display: flex;
    gap: 3px;
    justify-content: center;
}

.discard-card {
    width: 25px;
    height: 35px;
    background: white;
    border-radius: 3px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 2px;
    font-size: 10px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

.discard-card.red {
    color: #e74c3c;
}

.discard-card.black {
    color: #2c3e50;
}

/* ç©å®¶çŠ¶æ€æ ·å¼ */
.players-status {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 15px 0;
    justify-content: center;
}

.player-status {
    background: white;
    border-radius: 8px;
    padding: 10px;
    min-width: 120px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.player-status.current {
    border-color: #667eea;
    background: #f0f4ff;
}

.player-status.passed {
    border-color: gold;
    background: #fff9e6;
}

.player-name {
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
}

.player-cards {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 5px;
}

.player-pass {
    color: #d4af37;
    font-weight: bold;
    font-size: 0.8em;
    background: gold;
    padding: 2px 8px;
    border-radius: 10px;
    display: inline-block;
}

.player-turn {
    color: #667eea;
    font-weight: bold;
    font-size: 0.8em;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 480px) {
    .table-center {
        flex-direction: column;
        gap: 15px;
    }
    
    .discard-area {
        margin-left: 0;
        width: 100%;
    }
    
    .player-status {
        min-width: 100px;
        padding: 8px;
    }
}
        
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .container {
                border-radius: 10px;
            }
            
            header {
                padding: 12px 15px;
            }
            
            h1 {
                font-size: 1.3em;
            }
            
            .content {
                padding: 12px;
            }
            
            .card {
                width: 50px;
                height: 70px;
            }
            
            .card-value {
                font-size: 14px;
            }
            
            .card-suit {
                font-size: 12px;
            }
            
            input, button {
                padding: 10px 12px;
            }
        }
        
        @media (max-width: 320px) {
            .card {
                width: 45px;
                height: 65px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å¹²çªçœ¼å„¿</h1>
            <div class="subtitle">èœœé›ªå†°åŸåœ¨çº¿ç‰ˆ</div>
        </header>
        
        <div class="content">
            <div id="connectionStatus" class="connection-status disconnected">
                <div class="status-dot"></div>
                <span>è¿æ¥æ–­å¼€</span>
            </div>
            
            <div id="lobbyView">
                <div class="form-group">
                    <label for="playerName">ç©å®¶åç§°</label>
                    <input type="text" id="playerName" placeholder="è¯·è¾“å…¥æ‚¨çš„åç§°" value="ç©å®¶">
                </div>
                
                <div class="form-group">
                    <button id="createRoomBtn">åˆ›å»ºæˆ¿é—´</button>
                </div>
                
                <div class="divider">æˆ–</div>
                
                <div class="form-group">
                    <label for="roomId">æˆ¿é—´å·</label>
                    <input type="text" id="roomId" placeholder="è¾“å…¥æˆ¿é—´å·">
                </div>
                
                <div class="form-group">
                    <button id="joinRoomBtn">åŠ å…¥æˆ¿é—´</button>
                </div>
            </div>
            
            <div id="roomView" class="hidden">
                <div class="room-info">
                    <h3>æˆ¿é—´ä¿¡æ¯</h3>
                    <p>æˆ¿é—´å·: <strong id="currentRoomId">-</strong></p>
                    <p>ç©å®¶ID: <span id="currentPlayerId">-</span></p>
                    
                    <div class="players-list">
                        <h4>ç©å®¶åˆ—è¡¨</h4>
                        <div id="playersList"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <button id="startGameBtn" disabled>å¼€å§‹æ¸¸æˆ</button>
                </div>
                
                <div class="form-group">
                    <button id="leaveRoomBtn" style="background: #6c757d;">ç¦»å¼€æˆ¿é—´</button>
                </div>
            </div>
            
            <div id="gameView" class="hidden">
                <div class="game-area">
                    <h3>æ¸¸æˆè¿›è¡Œä¸­</h3>
                    <!-- åœ¨è¿™é‡Œæ·»åŠ ç‰Œæ¡ŒçŠ¶æ€æ˜¾ç¤º -->
        <div class="game-table">
            <div class="table-center">
                <div class="draw-pile">
                    <div class="pile-label">ç‰Œå †</div>
                    <div class="pile-count" id="drawPileCount">54</div>
                </div>
                <div class="discard-area">
                    <h4>å‡ºç‰Œè®°å½•</h4>
                    <div id="discardHistory" class="discard-history">
                        <!-- å‡ºç‰Œå†å²å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
<!-- åœ¨è¿™é‡Œæ·»åŠ ç©å®¶çŠ¶æ€æ˜¾ç¤º -->
        <div class="players-status" id="playersStatus">
            <!-- ç©å®¶çŠ¶æ€å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
                    <div class="player-hand" id="playerHand">
                        <!-- æ‰‹ç‰Œå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <div class="game-controls">
                        <button id="playCardsBtn" disabled>å‡ºç‰Œ</button>
                        <button id="passTurnBtn" disabled>ä¸å‡º</button>
                    </div>
                </div>
            </div>
            
            <div class="messages" id="gameMessages">
                <div class="message">æ¬¢è¿çªçœ¼å„¿ï¼å‡†å¤‡å¥½èœœé›ªå†°åŸäº†å—ï¼Ÿ</div>
            </div>
        </div>
    </div>

<script>
    // æ¸¸æˆçŠ¶æ€å˜é‡
    let currentRoomId = null;
    let currentPlayerId = null;
    let playerHand = [];
    let selectedCards = [];
    let clientId = null;
    let pollInterval = null;
    let lastMyTurnMessage = 0;
    
   // ç”Ÿæˆå®¢æˆ·ç«¯ID
function generateClientId() {
    return 'client_' + Math.random().toString(36).substr(2, 9);
}

// åˆå§‹åŒ–
function initialize() {
    // ç”Ÿæˆå®¢æˆ·ç«¯ID
    clientId = generateClientId();
     
    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    document.getElementById('createRoomBtn').addEventListener('click', createRoom);
    document.getElementById('joinRoomBtn').addEventListener('click', joinRoom);
    document.getElementById('startGameBtn').addEventListener('click', startGame);
    document.getElementById('leaveRoomBtn').addEventListener('click', leaveRoom);
    document.getElementById('playCardsBtn').addEventListener('click', playCards);
    document.getElementById('passTurnBtn').addEventListener('click', passTurn);
    
    // æ·»åŠ å›è½¦é”®æ”¯æŒ
    document.getElementById('roomId').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            joinRoom();
        }
    });
    
    document.getElementById('playerName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            createRoom();
        }
    });
    
    // æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
    document.addEventListener('touchstart', function() {}, {passive: true});
    
    showMessage('æ¸¸æˆå·²å°±ç»ªï¼Œè¯·è¾“å…¥æˆ¿é—´å·æˆ–åˆ›å»ºæ–°æˆ¿é—´');
    
    // å¢å¼ºçš„è¿æ¥æµ‹è¯•
    testConnection();
    
    // æ·»åŠ é‡æ–°è¿æ¥æŒ‰é’®
    addReconnectButton();

    // å¯åŠ¨è¿æ¥ç›‘æ§
    startConnectionMonitor();
}   
   
// å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨ - ä¿®å¤å‚æ•°å¤„ç†
async function sendRequest(action, data = {}) {
    const url = '/api/game';
    
    // æ„å»ºè¯·æ±‚æ•°æ®ï¼Œç¡®ä¿æ­£ç¡®å¤„ç†æ‰€æœ‰å‚æ•°
    const requestData = {
        action: action,
        clientId: clientId,
        ...data  
    };
    
    // åªæœ‰åœ¨å·²æœ‰æˆ¿é—´å’Œç©å®¶IDæ—¶æ‰æ·»åŠ è¿™äº›å‚æ•°
    if (currentRoomId) {
        requestData.roomId = currentRoomId;
    }
    if (currentPlayerId) {
        requestData.playerId = currentPlayerId;
    }
    
    try {
        console.log('å‘é€è¯·æ±‚:', action, 'æ•°æ®:', requestData);
        
        // æ·»åŠ è¶…æ—¶æ§åˆ¶
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000); // 8ç§’è¶…æ—¶
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
if (!response.ok) {
            // å¤„ç†ç‰¹å®šçš„ HTTP é”™è¯¯
            if (response.status === 502 || response.status === 504) {
                throw new Error('æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•');
            }
            throw new Error(`HTTPé”™è¯¯: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('æ”¶åˆ°å“åº”:', result);
        
        if (!result.success) {
            // ç‰¹æ®Šå¤„ç†æˆ¿é—´ä¸å­˜åœ¨çš„æƒ…å†µ
            if (result.error && result.error.includes('æˆ¿é—´ä¸å­˜åœ¨')) {
                return { success: false, error: 'æˆ¿é—´ä¸å­˜åœ¨' };
            }
            throw new Error(result.error || 'è¯·æ±‚å¤±è´¥');
        }
        
        return result;
    } catch (error) {
        console.error('è¯·æ±‚é”™è¯¯:', error);
        
        let errorMessage = 'ç½‘ç»œé”™è¯¯: ';
        if (error.name === 'AbortError') {
            errorMessage += 'è¯·æ±‚è¶…æ—¶';
        } else if (error.message.includes('Failed to fetch')) {
            errorMessage += 'è¿æ¥å¤±è´¥ï¼ŒæœåŠ¡å™¨å¯èƒ½æ­£åœ¨é‡å¯';
        } else {
            errorMessage += error.message;
        }
        
        showMessage(errorMessage);
        updateConnectionStatus(false);
         throw error;
    }
}
    
    // æ£€æŸ¥æˆ¿é—´æ˜¯å¦å­˜åœ¨
    async function checkRoomExists(roomId) {
        try {
            const result = await sendRequest('check_room', { roomId: roomId });
            return result.exists;
        } catch (error) {
            console.error('æ£€æŸ¥æˆ¿é—´å¤±è´¥:', error);
            return false;
        }
    }
    
   
    
// å¼€å§‹è½®è¯¢
function startPolling() {
    stopPolling();
    pollUpdates(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    
    // é™ä½è½®è¯¢é¢‘ç‡ï¼Œé¿å…è§¦å‘ Vercel é™åˆ¶
    pollInterval = setInterval(pollUpdates, 8000); // æ”¹ä¸º8ç§’
}

// è½®è¯¢æ›´æ–°
async function pollUpdates() {
    if (!currentRoomId || !currentPlayerId) return;
    
    try {
        console.log('å‘é€è½®è¯¢è¯·æ±‚...');
        const result = await sendRequest('get_updates');
        
        if (result.success) {
            updateConnectionStatus(true);
            result.messages.forEach(handleServerMessage);
            if (result.roomState) {
                updateGameState(result.roomState);
            }
        } else {
            updateConnectionStatus(false);
            // å¤„ç†æˆ¿é—´ä¸å­˜åœ¨çš„æƒ…å†µ
            if (result.error && result.error.includes('æˆ¿é—´ä¸å­˜åœ¨')) {
                showMessage('æˆ¿é—´å·²ä¸å­˜åœ¨ï¼Œè¿”å›å¤§å…');
                setTimeout(() => resetGame(), 2000);
            }
        }
    } catch (error) {
        console.error('è½®è¯¢é”™è¯¯:', error);
        updateConnectionStatus(false);
        
        // ä¸ç«‹å³é‡è¯•ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è½®è¯¢
    }
}
    
    // åœæ­¢è½®è¯¢
    function stopPolling() {
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
    }
    
    // å¤„ç†æœåŠ¡å™¨æ¶ˆæ¯
    function handleServerMessage(data) {
        console.log('å¤„ç†æ¶ˆæ¯:', data);
        
        switch (data.type) {
            case 'room_created':
                handleRoomCreated(data);
                break;
            case 'room_joined':
                handleRoomJoined(data);
                break;
            case 'player_joined':
                handlePlayerJoined(data);
                break;
            case 'player_left':
                handlePlayerLeft(data);
                break;
            case 'game_started':
                handleGameStarted(data);
                break;
            case 'player_hand':
                handlePlayerHand(data);
                break;
            case 'card_played':
                handleCardPlayed(data);
                break;
            case 'turn_passed':
                handleTurnPassed(data);
                break;
            case 'game_ended':
                handleGameEnded(data);
                break;
        }
    }
    
    // å¤„ç†æˆ¿é—´åˆ›å»º
    function handleRoomCreated(data) {
        currentRoomId = data.roomId;
        currentPlayerId = data.playerId;
        
        document.getElementById('lobbyView').classList.add('hidden');
        document.getElementById('roomView').classList.remove('hidden');
        
        document.getElementById('currentRoomId').textContent = currentRoomId;
        document.getElementById('currentPlayerId').textContent = currentPlayerId;
        
        showMessage('æˆ¿é—´åˆ›å»ºæˆåŠŸï¼æˆ¿é—´å·: ' + currentRoomId);
        startPolling();
    }
    
    // å¤„ç†åŠ å…¥æˆ¿é—´
    function handleRoomJoined(data) {
        currentRoomId = data.roomId;
        currentPlayerId = data.playerId;
        
        document.getElementById('lobbyView').classList.add('hidden');
        document.getElementById('roomView').classList.remove('hidden');
        
        document.getElementById('currentRoomId').textContent = currentRoomId;
        document.getElementById('currentPlayerId').textContent = currentPlayerId;
        
        updatePlayersList(data.players);
        showMessage('æˆåŠŸåŠ å…¥æˆ¿é—´: ' + currentRoomId);
        startPolling();
    }
    
    // å¤„ç†ç©å®¶åŠ å…¥
    function handlePlayerJoined(data) {
        updatePlayersList(data.players);
        showMessage('ç©å®¶ ' + data.playerName + ' åŠ å…¥äº†æˆ¿é—´');
        
        // å¦‚æœç©å®¶æ•°é‡è¶³å¤Ÿï¼Œå¯ç”¨å¼€å§‹æ¸¸æˆæŒ‰é’®
        const startGameBtn = document.getElementById('startGameBtn');
        if (data.players && data.players.length >= 2) {
            startGameBtn.disabled = false;
        }
    }
    
    // å¤„ç†ç©å®¶ç¦»å¼€
    function handlePlayerLeft(data) {
        updatePlayersList(data.players);
        showMessage('ç©å®¶ ' + data.playerName + ' ç¦»å¼€äº†æˆ¿é—´');
        
        // å¦‚æœç©å®¶æ•°é‡ä¸è¶³ï¼Œç¦ç”¨å¼€å§‹æ¸¸æˆæŒ‰é’®
        const startGameBtn = document.getElementById('startGameBtn');
        if (data.players && data.players.length < 2) {
            startGameBtn.disabled = true;
        }
    }
    
// å¤„ç†æ¸¸æˆå¼€å§‹æ¶ˆæ¯ - å¢å¼ºç‰ˆæœ¬
function handleGameStarted(data) {
    console.log('å¤„ç†æ¸¸æˆå¼€å§‹æ¶ˆæ¯:', data);
    
    // éšè—æˆ¿é—´è§†å›¾ï¼Œæ˜¾ç¤ºæ¸¸æˆè§†å›¾
    document.getElementById('roomView').classList.add('hidden');
    document.getElementById('gameView').classList.remove('hidden');
    
    let message = data.message || 'æ¸¸æˆå¼€å§‹ï¼';
    if (data.dealer === currentPlayerId) {
        message += ' æ‚¨æ˜¯åº„å®¶ï¼Œè¯·å…ˆå‡ºç‰Œ';
    } else {
        message += ' ç­‰å¾…å…¶ä»–ç©å®¶å‡ºç‰Œ...';
    }
    
    showMessage(message);
    
    // æ›´æ–°ç©å®¶åˆ—è¡¨æ˜¾ç¤º
    if (window.currentRoomState && window.currentRoomState.players) {
        updatePlayersList(window.currentRoomState.players);
    }
}

// å¤„ç†æ‰‹ç‰Œæ¶ˆæ¯ - å¢å¼ºç‰ˆæœ¬
function handlePlayerHand(data) {
    console.log('æ”¶åˆ°æ‰‹ç‰Œ:', data);
    playerHand = data.hand || [];
    
    // æŒ‰ç‰Œå€¼æ’åºæ‰‹ç‰Œï¼Œæ–¹ä¾¿ç©å®¶æŸ¥çœ‹
    playerHand.sort((a, b) => {
        const values = ['3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A', '2', 'Joker'];
        return values.indexOf(a.value) - values.indexOf(b.value);
    });
    
    renderPlayerHand();
    showMessage(`æ‚¨æ”¶åˆ° ${data.handCount || playerHand.length} å¼ æ‰‹ç‰Œ`);
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç©å®¶å›åˆ
    if (window.currentRoomState && window.currentRoomState.currentPlayer === currentPlayerId) {
        showMessage('èµ¶ç´§å‡ºç‰Œï¼');
    }
}
    
    // å¤„ç†å‡ºç‰Œ
    function handleCardPlayed(data) {
        showMessage('ç©å®¶ ' + data.playerName + ' å‡ºäº† ' + data.play.cards.length + ' å¼ ç‰Œ');
    }
    
    // å¤„ç†è·³è¿‡å›åˆ
    function handleTurnPassed(data) {
        showMessage('ç©å®¶ ' + data.playerName + ' é€‰æ‹©ä¸å‡ºç‰Œ');
    }
    
    // å¤„ç†æ¸¸æˆç»“æŸ
    function handleGameEnded(data) {
        showMessage('æ¸¸æˆç»“æŸï¼è·èƒœè€…: ' + data.winnerName + (data.specialResult ? ' (' + data.specialResult + ')' : ''));
        
        setTimeout(() => {
            if (confirm('æ¸¸æˆç»“æŸï¼æ˜¯å¦è¿”å›å¤§å…ï¼Ÿ')) {
                leaveRoom();
            }
        }, 2000);
    }
    
    // æ›´æ–°ç©å®¶åˆ—è¡¨
    function updatePlayersList(players) {
        const playersList = document.getElementById('playersList');
        playersList.innerHTML = '';
        
        if (!players || players.length === 0) return;
        
        players.forEach(player => {
            const playerItem = document.createElement('div');
            playerItem.className = 'player-item';
            playerItem.textContent = player.name + (player.id === currentPlayerId ? ' (æˆ‘)' : '') + ' - ' + player.cards + ' å¼ ç‰Œ';
            playersList.appendChild(playerItem);
        });
    }
// æ›´æ–°ç‰Œæ¡ŒçŠ¶æ€
function updateTableState(roomState) {
    // è¿™é‡Œå¯ä»¥æ·»åŠ ç‰Œæ¡Œçš„è§†è§‰æ›´æ–°é€»è¾‘
    console.log('æ›´æ–°ç‰Œæ¡ŒçŠ¶æ€:', roomState);
    
    // æ›´æ–°ç‰Œå †æ•°é‡
    const drawPileCount = document.getElementById('drawPileCount');
    if (drawPileCount && roomState.drawPileCount !== undefined) {
        drawPileCount.textContent = roomState.drawPileCount;
    }
}

// æ›´æ–°ç©å®¶çŠ¶æ€æ˜¾ç¤º
function updatePlayersStatus(roomState) {
    const playersStatus = document.getElementById('playersStatus');
    if (!playersStatus || !roomState.players) return;
    
    playersStatus.innerHTML = '';
    
    roomState.players.forEach(player => {
        const playerStatus = document.createElement('div');
        const isCurrent = player.id === roomState.currentPlayer;
        const isMe = player.id === currentPlayerId;
        const hasPassed = player.passed || false;
        
        playerStatus.className = `player-status ${isCurrent ? 'current' : ''} ${hasPassed ? 'passed' : ''}`;
        
        let statusHTML = `
            <div class="player-name">${player.name}${isMe ? ' (æˆ‘)' : ''}</div>
            <div class="player-cards">${player.cards} å¼ ç‰Œ</div>
        `;
        
        if (hasPassed) {
            statusHTML += `<div class="player-pass">PASS</div>`;
        } else if (isCurrent) {
            statusHTML += `<div class="player-turn">å½“å‰å›åˆ</div>`;
        }
        
        playerStatus.innerHTML = statusHTML;
        playersStatus.appendChild(playerStatus);
    });
}

// æ›´æ–°å‡ºç‰Œå†å²
function updateDiscardHistory(recentPlays) {
    const discardHistory = document.getElementById('discardHistory');
    if (!discardHistory) return;
    
    discardHistory.innerHTML = '';
    
    if (!recentPlays || recentPlays.length === 0) {
        discardHistory.innerHTML = '<div style="color: rgba(255,255,255,0.7); text-align: center;">æš‚æ— å‡ºç‰Œè®°å½•</div>';
        return;
    }
    
    // åªæ˜¾ç¤ºæœ€è¿‘2è½®å‡ºç‰Œ
    const displayPlays = recentPlays.slice(-2);
    
    displayPlays.forEach(play => {
        const playElement = document.createElement('div');
        playElement.className = 'discard-play';
        
        let cardsHTML = '';
        if (play.cards && play.cards.length > 0) {
            play.cards.forEach(card => {
                cardsHTML += `
                    <div class="discard-card ${card.color}">
                        <div class="card-value">${card.value}</div>
                        <div class="card-suit">${card.suit}</div>
                    </div>
                `;
            });
        }
        
        playElement.innerHTML = `
            <div class="discard-player">${play.playerName}</div>
            <div class="discard-cards">${cardsHTML}</div>
        `;
        
        discardHistory.appendChild(playElement);
    });
}
// æ›´æ–°æ¸¸æˆçŠ¶æ€ - å¢å¼ºç‰ˆæœ¬
function updateGameState(roomState) {
    console.log('æ›´æ–°æ¸¸æˆçŠ¶æ€:', roomState);
    
    // æ›´æ–°ç‰Œæ¡ŒçŠ¶æ€
    updateTableState(roomState);
    
    // æ›´æ–°ç©å®¶çŠ¶æ€
    updatePlayersStatus(roomState);
    
    // æ›´æ–°å‡ºç‰Œå†å²
    if (roomState.recentPlays) {
        updateDiscardHistory(roomState.recentPlays);
    }
    
    // ä¿å­˜æˆ¿é—´çŠ¶æ€ä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
    window.currentRoomState = roomState;
    
    if (roomState && roomState.players) {
        updatePlayersList(roomState.players);
    }
    
    // æ›´æ–°æ¸¸æˆæ§åˆ¶æŒ‰é’®çŠ¶æ€
    const isMyTurn = roomState && roomState.gameStarted && roomState.currentPlayer === currentPlayerId;
    const playCardsBtn = document.getElementById('playCardsBtn');
    const passTurnBtn = document.getElementById('passTurnBtn');
    
    if (playCardsBtn && passTurnBtn) {
        playCardsBtn.disabled = !isMyTurn || selectedCards.length === 0;
        passTurnBtn.disabled = !isMyTurn;
    }
    
    // æ›´æ–°å¼€å§‹æ¸¸æˆæŒ‰é’®çŠ¶æ€ï¼ˆåœ¨æˆ¿é—´è§†å›¾ä¸­ï¼‰
    const startGameBtn = document.getElementById('startGameBtn');
    if (startGameBtn) {
        const canStartGame = roomState && !roomState.gameStarted && roomState.players && roomState.players.length >= 2;
        startGameBtn.disabled = !canStartGame;
        
        if (canStartGame) {
            startGameBtn.textContent = 'å¼€å§‹æ¸¸æˆ';
        } else if (roomState && roomState.gameStarted) {
            startGameBtn.textContent = 'æ¸¸æˆå·²å¼€å§‹';
        } else {
            startGameBtn.textContent = `éœ€è¦è‡³å°‘2åç©å®¶ (å½“å‰: ${roomState.players ? roomState.players.length : 0})`;
        }
    }
    
    // é˜²æ­¢é‡å¤æ˜¾ç¤ºå›åˆæ¶ˆæ¯
    if (isMyTurn) {
        const now = Date.now();
        if (now - lastMyTurnMessage > 10000) { // 10ç§’å†…åªæ˜¾ç¤ºä¸€æ¬¡
            showMessage('èµ¶ç´§å‡ºç‰Œï¼');
            lastMyTurnMessage = now;
        }
    }
}
    
    // æ¸²æŸ“ç©å®¶æ‰‹ç‰Œ
    function renderPlayerHand() {
        const playerHandElement = document.getElementById('playerHand');
        playerHandElement.innerHTML = '';
        
        if (!playerHand || playerHand.length === 0) return;
        
        playerHand.forEach((card, index) => {
            const cardElement = document.createElement('div');
            cardElement.className = `card ${card.color}`;
            cardElement.innerHTML = `
                <div class="card-value">${card.value}</div>
                <div class="card-suit">${card.suit}</div>
                <div class="card-value" style="transform: rotate(180deg);">${card.value}</div>
            `;
            
            cardElement.addEventListener('click', () => {
                toggleCardSelection(index);
            });
            
            playerHandElement.appendChild(cardElement);
        });
    }
    
    // åˆ‡æ¢å¡ç‰Œé€‰æ‹©
    function toggleCardSelection(index) {
        const cardElements = document.querySelectorAll('.card');
        const cardElement = cardElements[index];
        
        if (selectedCards.includes(index)) {
            selectedCards = selectedCards.filter(i => i !== index);
            cardElement.classList.remove('selected');
        } else {
            selectedCards.push(index);
            cardElement.classList.add('selected');
        }
        
        // æ›´æ–°å‡ºç‰ŒæŒ‰é’®çŠ¶æ€
        const playCardsBtn = document.getElementById('playCardsBtn');
        playCardsBtn.disabled = selectedCards.length === 0;
    }
    
    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(message) {
        const messagesElement = document.getElementById('gameMessages');
        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        messageElement.textContent = message;
        
        messagesElement.appendChild(messageElement);
        
        // é™åˆ¶æ¶ˆæ¯æ•°é‡ï¼Œé˜²æ­¢è¿‡å¤š
        if (messagesElement.children.length > 20) {
            messagesElement.removeChild(messagesElement.firstChild);
        }
        
        messagesElement.scrollTop = messagesElement.scrollHeight;
    }
    
    // æ›´æ–°è¿æ¥çŠ¶æ€
function updateConnectionStatus(connected) {
    const connectionStatus = document.getElementById('connectionStatus');
    if (connected) {
        connectionStatus.className = 'connection-status connected';
        connectionStatus.innerHTML = '<div class="status-dot"></div><span>âœ… å·²è¿æ¥åˆ°æœåŠ¡å™¨</span>';
    } else {
        connectionStatus.className = 'connection-status disconnected';
        connectionStatus.innerHTML = '<div class="status-dot"></div><span>è¿æ¥æ–­å¼€ - ç‚¹å‡»é‡è¯•</span>';

 // æ·»åŠ é‡è¯•åŠŸèƒ½
        connectionStatus.onclick = async function() {
            showMessage('ğŸ”„ é‡æ–°è¿æ¥ä¸­...');
            await testConnection();
            if (currentRoomId && currentPlayerId) {
                // å¦‚æœä¹‹å‰åœ¨æˆ¿é—´ä¸­ï¼Œå°è¯•é‡æ–°åŠ å…¥
                setTimeout(() => pollUpdates(), 1000);
            }
        };
    }
}
    
    // åˆ›å»ºæˆ¿é—´
    async function createRoom() {
        const playerName = document.getElementById('playerName').value.trim() || 'ç©å®¶';
        
        try {
            const result = await sendRequest('create_room', { playerName });
            handleServerMessage(result);
        } catch (error) {
            // é”™è¯¯å·²åœ¨ sendRequest ä¸­å¤„ç†
        }
    }
    
// åŠ å…¥æˆ¿é—´ - å®Œå…¨ä¿®å¤ç‰ˆæœ¬
async function joinRoom() {
    const roomIdInput = document.getElementById('roomId');
    const roomId = roomIdInput.value.trim();
    const playerName = document.getElementById('playerName').value.trim() || 'ç©å®¶';
    
    console.log('å°è¯•åŠ å…¥æˆ¿é—´:', roomId, 'ç©å®¶:', playerName);
    
    if (!roomId) {
        showMessage('è¯·è¾“å…¥æˆ¿é—´å·');
        roomIdInput.focus();
        return;
    }
    
    if (roomId.length < 4) {
        showMessage('æˆ¿é—´å·æ ¼å¼ä¸æ­£ç¡®');
        roomIdInput.focus();
        return;
    }
    
    try {
        showMessage('æ­£åœ¨åŠ å…¥æˆ¿é—´ ' + roomId + '...');
        
        // ç›´æ¥å‘é€è¯·æ±‚ï¼Œä¸ä¾èµ–currentRoomIdï¼ˆæ­¤æ—¶ä¸ºnullï¼‰
        const result = await sendRequest('join_room', { 
            roomId: roomId, 
            playerName: playerName 
        });
        
        console.log('åŠ å…¥æˆ¿é—´å“åº”:', result);
        
        if (result.success) {
            handleServerMessage(result);
        } else {
            // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            let errorMsg = result.error || 'åŠ å…¥æˆ¿é—´å¤±è´¥';
            if (result.debug) {
                errorMsg += ' (è¯·æ±‚: ' + result.debug.requested + ', æ ‡å‡†åŒ–: ' + result.debug.normalized + ')';
                if (result.debug.availableRooms && result.debug.availableRooms.length > 0) {
                    errorMsg += 'ã€‚å¯ç”¨æˆ¿é—´: ' + result.debug.availableRooms.join(', ');
                }
            }
            showMessage(errorMsg);
            
            // å¦‚æœæ˜¯æˆ¿é—´ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºåˆ›å»ºæˆ¿é—´çš„æç¤º
            if (result.error === 'æˆ¿é—´ä¸å­˜åœ¨') {
                showMessage('æç¤ºï¼šæ‚¨å¯ä»¥ç‚¹å‡»"åˆ›å»ºæˆ¿é—´"æŒ‰é’®åˆ›å»ºæ–°æˆ¿é—´');
            }
        }
    } catch (error) {
        console.error('åŠ å…¥æˆ¿é—´ç½‘ç»œé”™è¯¯:', error);
        showMessage('ç½‘ç»œé”™è¯¯: ' + error.message);
    }
}
    
    // ç¦»å¼€æˆ¿é—´
    async function leaveRoom() {
        try {
            if (currentRoomId && currentPlayerId) {
                await sendRequest('leave_room');
            }
        } catch (error) {
            // é™é»˜å¤„ç†
        }
        
        resetGame();
        showMessage('å·²ç¦»å¼€æˆ¿é—´');
    }
// å¼€å§‹æ¸¸æˆ - æ·»åŠ è¯¦ç»†è°ƒè¯•
async function startGame() {
    console.log('å¼€å§‹æ¸¸æˆæŒ‰é’®è¢«ç‚¹å‡»');
    console.log('å½“å‰æˆ¿é—´ID:', currentRoomId);
    console.log('å½“å‰ç©å®¶ID:', currentPlayerId);
    
    try {
        showMessage('æ­£åœ¨å¼€å§‹æ¸¸æˆ...');
        const result = await sendRequest('start_game');
        console.log('å¼€å§‹æ¸¸æˆå“åº”:', result);
        
        if (result.success) {
            showMessage('æ¸¸æˆå¼€å§‹è¯·æ±‚å·²å‘é€');
        } else {
            showMessage('å¼€å§‹æ¸¸æˆå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        console.error('å¼€å§‹æ¸¸æˆé”™è¯¯:', error);
        showMessage('å¼€å§‹æ¸¸æˆé”™è¯¯: ' + error.message);
    }
}

    // å‡ºç‰Œ
    async function playCards() {
        if (selectedCards.length === 0) {
            showMessage('è¯·é€‰æ‹©è¦å‡ºçš„ç‰Œ');
            return;
        }
        
        const cardsToPlay = selectedCards.map(index => playerHand[index]);
        
        try {
            await sendRequest('play_cards', { cards: cardsToPlay });
            selectedCards = [];
        } catch (error) {
            // é”™è¯¯å·²åœ¨ sendRequest ä¸­å¤„ç†
        }
    }
    
    // è·³è¿‡å›åˆ
    async function passTurn() {
        try {
            await sendRequest('pass_turn');
        } catch (error) {
            // é”™è¯¯å·²åœ¨ sendRequest ä¸­å¤„ç†
        }
    }
    
    // é‡ç½®æ¸¸æˆ
    function resetGame() {
        stopPolling();
        
        document.getElementById('roomView').classList.add('hidden');
        document.getElementById('gameView').classList.add('hidden');
        document.getElementById('lobbyView').classList.remove('hidden');
        
        currentRoomId = null;
        currentPlayerId = null;
        playerHand = [];
        selectedCards = [];
        lastMyTurnMessage = 0;
        
        updateConnectionStatus(true);
    }

// å¢å¼ºçš„è¿æ¥æµ‹è¯•
async function testConnection() {
    try {
        showMessage('ğŸ” æµ‹è¯•æœåŠ¡å™¨è¿æ¥...');
        updateConnectionStatus(false);
        
        // æµ‹è¯•å¤šä¸ªå¯èƒ½çš„ç«¯ç‚¹
        const endpoints = [
            { url: '/health.json', name: 'é™æ€å¥åº·æ£€æŸ¥' },
            { url: '/api/health', name: 'API å¥åº·æ£€æŸ¥' },
            { url: '/api/game', name: 'æ¸¸æˆ API', method: 'POST', data: { action: 'check_room', roomId: 'test' } }
        ];
        
        let connected = false;
        
        for (let endpoint of endpoints) {
            try {
                console.log(`å°è¯•è¿æ¥: ${endpoint.url}`);
                let response;
                
                if (endpoint.method === 'POST') {
                    response = await fetch(endpoint.url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(endpoint.data || {})
                    });
                } else {
                    response = await fetch(endpoint.url);
                }
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`âœ… ${endpoint.name} è¿æ¥æˆåŠŸ:`, data);
                    
                    connected = true;
                    updateConnectionStatus(true);
                    
                    let message = `âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸ï¼`;
                    if (data.rooms !== undefined) {
                        message += ` å½“å‰æœ‰ ${data.rooms} ä¸ªæˆ¿é—´`;
                    }
                    showMessage(message);
                    break;
                } else {
                    console.log(`âŒ ${endpoint.name} å“åº”å¼‚å¸¸: ${response.status}`);
                }
            } catch (error) {
                console.log(`âŒ ${endpoint.name} è¿æ¥å¤±è´¥:`, error.message);
            }
        }
        
        if (!connected) {
            throw new Error('æ‰€æœ‰æœåŠ¡å™¨ç«¯ç‚¹è¿æ¥å¤±è´¥');
        }
        
    } catch (error) {
        console.error('è¿æ¥æµ‹è¯•å®Œå…¨å¤±è´¥:', error);
        showMessage('âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥');
        showMessage('ğŸ’¡ å¯èƒ½çš„åŸå› :');
        showMessage('  1. API æœåŠ¡å™¨å¯åŠ¨ä¸­');
        showMessage('  2. ç½‘ç»œå»¶è¿Ÿï¼Œè¯·ç¨åé‡è¯•');
        updateConnectionStatus(false);
    }
}

// å¢å¼ºçš„é‡æ–°è¿æ¥åŠŸèƒ½
function addReconnectButton() {
    const connectionStatus = document.getElementById('connectionStatus');
    connectionStatus.style.cursor = 'pointer';
    connectionStatus.title = 'ç‚¹å‡»é‡æ–°æµ‹è¯•è¿æ¥';
    connectionStatus.addEventListener('click', async function() {
        showMessage('ğŸ”„ é‡æ–°è¿æ¥ä¸­...');
        await testConnection();
    });
}

// å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
function startConnectionMonitor() {
    // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡è¿æ¥çŠ¶æ€
    setInterval(async () => {
        if (currentRoomId) {
            // å¦‚æœåœ¨æˆ¿é—´ä¸­ï¼Œé€šè¿‡è½®è¯¢æ£€æŸ¥è¿æ¥
            try {
                await pollUpdates();
                updateConnectionStatus(true);
            } catch (error) {
                console.log('å®šæœŸæ£€æŸ¥è¿æ¥å¤±è´¥:', error);
                updateConnectionStatus(false);
            }
        } else {
            // å¦‚æœä¸åœ¨æˆ¿é—´ä¸­ï¼Œç®€å•æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¯è®¿é—®
            try {
                const response = await fetch('/health.json');
                if (response.ok) {
                    updateConnectionStatus(true);
                } else {
                    updateConnectionStatus(false);
                }
            } catch (error) {
                updateConnectionStatus(false);
            }
        }
    }, 30000);
}
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>